<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>نظام أخطار الفيضانات - رام الله</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Turf -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: "Segoe UI", Tahoma, Arial;
    }

    #sidebar {
      width: 220px;
      height: 100%;
      background: #fff;
      position: absolute;
      right: 0;
      top: 0;
      overflow-y: auto;
      padding: 15px;
      box-shadow: -2px 0 5px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 220px;
    }

    .legend {
      background: white;
      padding: 12px;
      font-size: 14px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      line-height: 20px;
    }

    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.9;
    }

    .north-arrow {
      padding: 5px;
      background: white;
      width: 60px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
    }
  </style>
</head>

<body>

<div id="sidebar">
  <h3 style="text-align:center;">نظام أخطار الفيضانات</h3>
  <h4>تقرير موقع المستخدم:</h4>
  <div id="userReport">جارٍ انتظار تحديد موقعك...</div>
</div>

<div id="map"></div>

<script>

// --------------------------------------------
// 1) ألوان مستويات الخطر حسب gridcode
// --------------------------------------------
function hazardColor(level) {
  level = Number(level);
  return level === 1 ? "#00cc44" :
         level === 2 ? "#ffff33" :
         level === 3 ? "#ff9933" :
         level === 4 ? "#ff3300" :
         level === 5 ? "#990000" :
         "#555";
}

// --------------------------------------------
// 2) إعداد الخريطة
// --------------------------------------------
var map = L.map("map").setView([31.9, 35.2], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

// --------------------------------------------
// 3) موقع المستخدم
// --------------------------------------------
map.locate({ setView: true, maxZoom: 14 });

map.on("locationfound", function(e) {
  L.marker(e.latlng).addTo(map).bindPopup("موقعك الحالي").openPopup();
  document.getElementById("userReport").innerHTML = "تم تحديد موقعك بنجاح.";
});

map.on("locationerror", function() {
  document.getElementById("userReport").innerHTML =
    "المتصفح لم يسمح بالوصول إلى موقعك.";
});

// --------------------------------------------
// 4) Popup الأصلي للطبقات
// --------------------------------------------
function popupGeneric(feature, layer) {
  let p = feature.properties;
  let html = "<b>بيانات الطبقة:</b><br>";
  for (let k in p) html += `<b>${k}:</b> ${p[k]}<br>`;
  layer.bindPopup(html);
}

// --------------------------------------------
// 5) Styles
// --------------------------------------------
function styleByGridCode(feature) {
  return {
    color: hazardColor(feature.properties.gridcode),
    weight: 1.5,
    fillOpacity: 0.45
  };
}

// --------------------------------------------
// 6) تحميل الطبقات
// --------------------------------------------
var layersControl = L.control.layers(null, {}, { collapsed: false }).addTo(map);

var floodLayer, zonesLayer, elevLayer, rainLayer, slopeLayer, soilLayer, flowLayer;

function loadLayer(file, styleFunc, popupFunc, label, assignTo) {
  fetch(file)
    .then(r => r.json())
    .then(data => {
      window[assignTo] = L.geoJSON(data, {
        style: styleFunc,
        onEachFeature: popupFunc
      }).addTo(map);

      layersControl.addOverlay(window[assignTo], label);
    });
}

// Flood الأساس
loadLayer("flood.json", styleByGridCode, popupGeneric, "Flood (أساس)", "floodLayer");

// باقي الطبقات
loadLayer("Ramallh_zones.json", styleByGridCode, popupGeneric, "Zones", "zonesLayer");
loadLayer("elev.json", styleByGridCode, popupGeneric, "Elevation", "elevLayer");
loadLayer("rain.json", styleByGridCode, popupGeneric, "Rainfall", "rainLayer");
loadLayer("slop.json", styleByGridCode, popupGeneric, "Slope", "slopeLayer");
loadLayer("flow_acu.json", styleByGridCode, popupGeneric, "Flow Accumulation", "flowLayer");
loadLayer("soil_new.json", styleByGridCode, popupGeneric, "Soil", "soilLayer");

// --------------------------------------------
// 7) Identify الذكي — فقط عند الضغط على منطقة فارغة
// --------------------------------------------
map.on("click", function(e) {

  if (e.originalEvent.target.classList.contains("leaflet-interactive")) return;

  let lat = e.latlng.lat.toFixed(6);
  let lng = e.latlng.lng.toFixed(6);

  let point = turf.point([lng, lat]);
  let info = {};

  function search(layer, name) {
    if (!layer) return;
    layer.eachLayer(function(lyr) {
      let poly = lyr.toGeoJSON();
      if (turf.booleanPointInPolygon(point, poly)) {
        info[name] = poly.properties;
      }
    });
  }

  search(floodLayer, "Flood");
  search(zonesLayer, "Zones");
  search(elevLayer, "Elevation");
  search(rainLayer, "Rainfall");
  search(slopeLayer, "Slope");
  search(flowLayer, "Flow");
  search(soilLayer, "Soil");

  let html = `<b>إحداثيات الموقع:</b><br>Lat: ${lat}<br>Lng: ${lng}<hr>`;

  if (info.Flood) html += `<b>الفيضانات:</b> خطر ${info.Flood.gridcode}<br>`;
  if (info.Elevation) html += `<b>الارتفاع:</b> ${info.Elevation.gridcode}<br>`;
  if (info.Slope) html += `<b>الانحدار:</b> ${info.Slope.gridcode}<br>`;
  if (info.Rainfall) html += `<b>المطر:</b> ${info.Rainfall.gridcode}<br>`;
  if (info.Zones) html += `<b>المنطقة:</b> ${info.Zones.gridcode}<br>`;
  if (info.Flow) html += `<b>تراكم الجريان:</b> ${info.Flow.gridcode}<br>`;
  if (info.Soil) html += `<b>التربة:</b> خطر ${info.Soil.gridcode}<br>`;

  L.popup().setLatLng(e.latlng).setContent(html).openOn(map);
});

// --------------------------------------------
// 8) Legend كبير وواضح
// --------------------------------------------
var legend = L.control({ position: "bottomleft" });

legend.onAdd = function() {
  var div = L.DomUtil.create("div", "legend");
  div.innerHTML += "<b>مستويات الخطر</b><br>";
  div.innerHTML += '<i style="background:#00cc44"></i> مستوى 1<br>';
  div.innerHTML += '<i style="background:#ffff33"></i> مستوى 2<br>';
  div.innerHTML += '<i style="background:#ff9933"></i> مستوى 3<br>';
  div.innerHTML += '<i style="background:#ff3300"></i> مستوى 4<br>';
  div.innerHTML += '<i style="background:#990000"></i> مستوى 5<br>';
  return div;
};

legend.addTo(map);

// --------------------------------------------
// 9) إشارة الشمال
// --------------------------------------------
var north = L.control({ position: "topright" });

north.onAdd = function() {
  var div = L.DomUtil.create("div", "north-arrow");
  div.innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/e/ed/North_arrow.svg" width="50">';
  return div;
};

north.addTo(map);

</script>

</body>
</html>
