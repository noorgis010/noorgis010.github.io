<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Flood Hazard – Ramallah & Al-Bireh</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Turf.js -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
    }

    /* الشريط الجانبي */
    #sidebar {
      width: 170px;
      height: 100%;
      background: #ffffff;
      position: absolute;
      right: 0;
      top: 0;
      overflow-y: auto;
      padding: 10px 10px 20px 10px;
      box-shadow: -2px 0 5px rgba(0,0,0,0.2);
      z-index: 1000;
      font-size: 12px;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 170px;
    }

    #sidebar h3 {
      text-align: center;
      margin-top: 5px;
      margin-bottom: 8px;
      font-size: 14px;
    }

    #sidebar h4 {
      margin: 8px 0 4px 0;
      font-size: 12px;
    }

    #btnHighlight, #btnReport {
      width: 100%;
      margin-top: 5px;
      padding: 5px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 11px;
    }

    #btnHighlight { background: #007bff; color: white; }
    #btnReport { background: #d9534f; color: white; }

    .legend {
      background: white;
      padding: 15px;
      font-size: 16px;
      border-radius: 10px;
      box-shadow: 0 0 12px rgba(0,0,0,0.3);
      line-height: 24px;
      width: 185px;
    }

    .legend i {
      width: 22px;
      height: 22px;
      float: left;
      margin-right: 10px;
    }

    .north-arrow {
      background: white;
      padding: 4px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.4);
    }

  </style>
</head>

<body>

<div id="sidebar">
  <h3>Flood Hazard</h3>

  <h4>Your Location</h4>
  <div id="userReport">Waiting…</div>

  <h4>Tools</h4>
  <button id="btnHighlight">Highlight Extreme Flood Risk</button>
  <button id="btnReport">Send Emergency Report</button>

  <h4>Buffer Tool</h4>
  <input id="buffDist" type="number" style="width:100%" placeholder="Distance (m)">
  <button id="btnBuffer" style="width:100%;margin-top:4px;background:#28a745;color:white;border:none;padding:5px;border-radius:6px;">
    Create Buffer
  </button>

  <div id="bufferReport" style="font-size:12px;margin-top:10px;"></div>
</div>

<div id="map"></div>

<script>
// =========================
// Hazard Color Function
// =========================
function hazardColor(level) {
  level = Number(level);
  return level === 1 ? "#00cc44" :
         level === 2 ? "#ffff33" :
         level === 3 ? "#ff9933" :
         level === 4 ? "#ff3300" :
         level === 5 ? "#990000" :
         "#555";
}

// توصية النص
function riskMessage(level) {
  level = Number(level);
  return level === 1 ? "Safe area" :
         level === 2 ? "Low hazard" :
         level === 3 ? "Moderate hazard" :
         level === 4 ? "High hazard" :
         level === 5 ? "Extreme hazard" :
         "Unknown";
}

// =========================
// Map
// =========================
var map = L.map("map").setView([31.9, 35.2], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// =========================
// User Location
// =========================
var lastAnalysis = null;
var userReportDiv = document.getElementById("userReport");

map.locate({ setView: true, maxZoom: 14 });

map.on("locationfound", e => {
  L.marker(e.latlng).addTo(map).bindPopup("Your location");
  userReportDiv.textContent = "Location detected.";
});

// ===============
// Styles
// ===============

// ★★★★★  Rainfall (10 classes Blue)  ★★★★★
function styleRain10(feature) {
  const gc = Number(feature.properties.gridcode);
  const colors = {
    1:"#e0f2ff", 2:"#cce7ff", 3:"#b3daff", 4:"#99ccff", 5:"#80bfff",
    6:"#66b2ff", 7:"#4da6ff", 8:"#3399ff", 9:"#1a8cff", 10:"#0073e6"
  };

  return {
    color: colors[gc] || "#004c99",
    fillColor: colors[gc] || "#004c99",
    fillOpacity: 0.55,
    weight: 1
  };
}

// باقي الطبقات = بدون تغيير
function styleByGridcode(feature) {
  return {
    color: hazardColor(feature.properties.gridcode),
    weight: 1,
    fillOpacity: 0.45
  };
}

function popupGeneric(feature, layer) {
  let p = feature.properties;
  let html = "<b>Attributes:</b><br>";
  for (let k in p) html += "<b>" + k + ":</b> " + p[k] + "<br>";
  layer.bindPopup(html);
}

// =========================
// Load Layers
// =========================
var layersControl = L.control.layers(null, {}, { collapsed:false }).addTo(map);

var floodLayer, zonesLayer, elevLayer, rainLayer, slopeLayer, soilLayer, flowLayer;
var floodSafePoints = null;

function loadLayer(file, styleFunc, popupFunc, label, assignTo){
  fetch(file).then(r=>r.json()).then(data=>{
    window[assignTo] = L.geoJSON(data, {
      style: styleFunc,
      onEachFeature: popupFunc
    }).addTo(map);

    layersControl.addOverlay(window[assignTo], label);

    if (assignTo === "floodLayer") {
      var safe = [];
      data.features.forEach(f=>{
        var gc = Number(f.properties.gridcode);
        if (gc===1 || gc===2) safe.push(turf.centroid(f));
      });
      floodSafePoints = turf.featureCollection(safe);
    }
  });
}

// flood
loadLayer("flood.json", styleByGridcode, popupGeneric, "Flood", "floodLayer");

// others unchanged
loadLayer("Ramallh_zones.json", styleByGridcode, popupGeneric, "Zones", "zonesLayer");
loadLayer("elev.json", styleByGridcode, popupGeneric, "Elevation", "elevLayer");
loadLayer("slop.json", styleByGridcode, popupGeneric, "Slope", "slopeLayer");
loadLayer("flow_acu.json", styleByGridcode, popupGeneric, "Flow Accumulation", "flowLayer");
loadLayer("soil_new.json", styleByGridcode, popupGeneric, "Soil", "soilLayer");

// ★★★ Rainfall (10 Levels)
loadLayer("rain.json", styleRain10, popupGeneric, "Rainfall (10 levels)", "rainLayer");

// =========================
// Click to Analyse
// =========================
map.on("click", function(e){
  if (e.originalEvent.target.classList.contains("leaflet-interactive")) return;

  var lat = e.latlng.lat.toFixed(6);
  var lng = e.latlng.lng.toFixed(6);
  var point = turf.point([lng, lat]);

  var info={};

  function search(layer,name){
    if(!layer) return;
    layer.eachLayer(lyr=>{
      var poly = lyr.toGeoJSON();
      if(turf.booleanPointInPolygon(point, poly)){ info[name]=poly.properties; }
    });
  }

  search(floodLayer,"Flood");
  search(rainLayer,"Rainfall");
  search(elevLayer,"Elevation");
  search(slopeLayer,"Slope");
  search(flowLayer,"Flow");
  search(soilLayer,"Soil");
  search(zonesLayer,"Zones");

  var html = `<b>Location:</b><br>
              Lat: ${lat}<br>
              Lng: ${lng}<hr>`;

  if(info.Flood){
    html+=`<b>Flood risk:</b> ${info.Flood.gridcode}<br>`;
    html+=`<b>Recommendation:</b> ${riskMessage(info.Flood.gridcode)}<hr>`;
  }

  if(info.Rainfall) html+=`Rainfall: ${info.Rainfall.gridcode}<br>`;
  if(info.Elevation) html+=`Elevation: ${info.Elevation.gridcode}<br>`;
  if(info.Slope)     html+=`Slope: ${info.Slope.gridcode}<br>`;
  if(info.Flow)      html+=`Flow: ${info.Flow.gridcode}<br>`;
  if(info.Soil)      html+=`Soil: ${info.Soil.gridcode}<br>`;
  if(info.Zones)     html+=`Zone: ${info.Zones.gridcode}<br>`;

  L.popup().setLatLng(e.latlng).setContent(html).openOn(map);

  lastAnalysis = {lat,lng,info};
});

// =========================
// Buffer
// =========================
var bufferLayer=null;
var bufferDisplay=null;

document.getElementById("btnBuffer").onclick = function(){
  var dist = Number(document.getElementById("buffDist").value);
  if(!dist){ alert("Enter buffer distance."); return; }

  map.once("click", function(e){
    var center = e.latlng;
    var km = dist/1000;
    var pt = turf.point([center.lng, center.lat]);
    var buff = turf.buffer(pt, km, {units:"kilometers"});

    // Remove old
    if(bufferLayer) map.removeLayer(bufferLayer);
    if(bufferDisplay) map.removeLayer(bufferDisplay);

    // visible circle
    bufferDisplay = L.circle(center,{
      radius:dist,
      color:"#0066ff",
      fillOpacity:0.15
    }).addTo(map);

    // invisible true polygon
    bufferLayer = L.geoJSON(buff, {style:{color:"#0066ff",weight:1,fillOpacity:0}}).addTo(map);

    map.fitBounds(bufferDisplay.getBounds());

    analyseBuffer(buff, center, dist);
  });

  alert("Click on the map to create buffer.");
};

function analyseBuffer(buff, center, dist){
  let report = `<b>Buffer Analysis</b><br>
  Center: ${center.lat.toFixed(5)}, ${center.lng.toFixed(5)}<br>
  Distance: ${dist} m<hr>`;

  function countInside(layer,name){
    if(!layer) return `<i>No ${name} layer</i><br>`;
    var count={};
    layer.eachLayer(lyr=>{
      var f=lyr.toGeoJSON();
      if(turf.booleanIntersects(buff,f)){
        var gc=f.properties.gridcode;
        count[gc]=(count[gc]||0)+1;
      }
    });
    return `<b>${name}:</b> ${JSON.stringify(count)}<br>`;
  }

  report+=countInside(floodLayer,"Flood");
  report+=countInside(rainLayer,"Rainfall");
  report+=countInside(flowLayer,"Flow");
  report+=countInside(slopeLayer,"Slope");
  report+=countInside(elevLayer,"Elevation");
  report+=countInside(soilLayer,"Soil");
  report+=countInside(zonesLayer,"Zones");

  document.getElementById("bufferReport").innerHTML = report;
}

// =========================
// Legend
// =========================
var legend = L.control({position:"bottomleft"});

legend.onAdd=function(){
  var div = L.DomUtil.create("div","legend");
  div.innerHTML="<b>Flood Hazard Levels</b><br>";
  div.innerHTML+='<i style="background:#00cc44"></i> Level 1<br>';
  div.innerHTML+='<i style="background:#ffff33"></i> Level 2<br>';
  div.innerHTML+='<i style="background:#ff9933"></i> Level 3<br>';
  div.innerHTML+='<i style="background:#ff3300"></i> Level 4<br>';
  div.innerHTML+='<i style="background:#990000"></i> Level 5<br>';
  return div;
};
legend.addTo(map);

// =========================
// North Arrow
// =========================
L.control({position:"topright"}).onAdd=function(){
  var div=L.DomUtil.create("div","north-arrow");
  div.innerHTML='<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Circle_arrow_north.svg/240px-Circle_arrow_north.svg.png" width="55">';
  return div;
}.addTo(map);
</script>

</body>
</html>



