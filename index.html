<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Flood Hazard â€“ Ramallah & Al-Bireh</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Turf.js -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- Measure -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-measure@3.3.0/dist/leaflet-measure.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet-measure@3.3.0/dist/leaflet-measure.min.js"></script>

  <style>
    body { margin:0; }
    #map { width:100%; height:100vh; }
    #userReport { background:#fff; padding:10px; }
  </style>
</head>

<body>
<div id="map"></div>
<div id="userReport"></div>

<script>

// =========================
// API CONFIG
// =========================
const OPENROUTESERVICE_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImU0MGJmYjNiZDY2ODRhNTdiYTg1MTZkZmVlN2Q1Yzg2IiwiaCI6Im11cm11cjY0In0=";
const OPENWEATHER_KEY = "384571a4172844344b2e6e07ca33c936";

// =========================
// MAP INIT
// =========================
var map = L.map("map", {
  center: [31.9, 35.2],
  zoom: 12
});

// base layers
let lightTiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

let darkTiles = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
  maxZoom: 19
});

map.doubleClickZoom.disable();

// =========================
// USER LOCATION
// =========================
let userReportDiv = document.getElementById("userReport");
let userLocation = null;

map.locate({ setView: true, maxZoom: 14 });

map.on("locationfound", e => {
  userLocation = e.latlng;
  L.marker(e.latlng).addTo(map).bindPopup("Your location");
  userReportDiv.textContent =
      `Location detected: ${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
});

map.on("locationerror", err => {
  console.error("Geolocation error", err);
  userReportDiv.textContent = "Location not available.";
});

// =========================
// HAZARD COLOR & MESSAGE
// =========================
function hazardColor(level) {
  level = Number(level);
  return level === 1 ? "#00cc44" :
         level === 2 ? "#ffff33" :
         level === 3 ? "#ff9933" :
         level === 4 ? "#ff3300" :
         level === 5 ? "#990000" :
         "#555";
}

function riskMessage(level) {
  level = Number(level);
  return level === 1 ? "Safe area" :
         level === 2 ? "Low hazard" :
         level === 3 ? "Moderate hazard" :
         level === 4 ? "High hazard" :
         level === 5 ? "Extreme hazard" :
         "Unknown";
}

// =========================
// STYLE FUNCTIONS
// =========================
function styleRain10(feature) {
  const gc = Number(feature.properties.gridcode);
  const colors = {
    1:"#e0f2ff",2:"#cce7ff",3:"#b3daff",4:"#99ccff",5:"#80bfff",
    6:"#66b2ff",7:"#4da6ff",8:"#3399ff",9:"#1a8cff",10:"#0073e6"
  };
  return {
    color: colors[gc] || "#004c99",
    fillColor: colors[gc] || "#004c99",
    fillOpacity: 0.55,
    weight: 1
  };
}

function styleBasic(feature) {
  return {
    color: hazardColor(feature.properties.gridcode),
    weight: 1,
    fillOpacity: 0.45
  };
}

function popupGeneric(feature, layer) {
  let p = feature.properties;
  let html = "<b>Attributes:</b><br>";
  for (let k in p) html += `<b>${k}:</b> ${p[k]}<br>`;
  layer.bindPopup(html);
}

// =========================
// LAYERS CONTROL
// =========================
var layersControl = L.control.layers(null, {}, { collapsed: false }).addTo(map);

// =========================
// LOAD LAYERS (with error handling)
// =========================
let floodSafePoints = null;

function loadLayer(file, styleFunc, label, assignTo, isRain) {
  fetch(file)
    .then(r => {
      if (!r.ok) throw new Error(`Failed to load ${file}`);
      return r.json();
    })
    .then(data => {
      window[assignTo] = L.geoJSON(data, {
        style: isRain ? styleRain10 : styleFunc,
        onEachFeature: popupGeneric
      }).addTo(map);

      layersControl.addOverlay(window[assignTo], label);

      if (assignTo === "floodLayer") {
        let safe = [];
        data.features.forEach(f => {
          let gc = Number(f.properties.gridcode);
          if (gc === 1 || gc === 2) safe.push(turf.centroid(f));
        });
        floodSafePoints = turf.featureCollection(safe);
      }
    })
    .catch(err => {
      console.error(err);
      alert(`Error loading layer: ${label}`);
    });
}

// load all layers
loadLayer("flood.json", styleBasic, "Flood", "floodLayer", false);
loadLayer("Ramallh_zones.json", styleBasic, "Zones", "zonesLayer", false);
loadLayer("elev.json", styleBasic, "Elevation", "elevLayer", false);
loadLayer("slop.json", styleBasic, "Slope", "slopeLayer", false);
loadLayer("flow_acu.json", styleBasic, "Flow Accumulation", "flowLayer", false);
loadLayer("soil_new.json", styleBasic, "Soil", "soilLayer", false);
loadLayer("rain.json", styleRain10, "Rainfall (10 levels)", "rainLayer", true);

// =========================
// WEATHER LAYER
// =========================
let weatherLayer;

function loadWeather() {
  let url = `https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${OPENWEATHER_KEY}`;

  if (weatherLayer && map.hasLayer(weatherLayer)) {
    map.removeLayer(weatherLayer);
  }

  weatherLayer = L.tileLayer(url, { opacity: 1 });
  weatherLayer.addTo(map);
}

loadWeather();
setInterval(loadWeather, 300000);

// =========================
// MEASURE TOOL
// =========================
var measureControl = new L.Control.Measure({
  primaryLengthUnit: "meters",
  secondaryLengthUnit: "kilometers",
  primaryAreaUnit: "sqmeters",
  secondaryAreaUnit: "hectares"
});
measureControl.addTo(map);

// =========================
// SAFE ROUTE FINDER
// =========================
let routeLayer;

function drawSafeRoute(start, end) {
  if (!start || !end) return;

  if (routeLayer) map.removeLayer(routeLayer);

  let url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${OPENROUTESERVICE_KEY}`;

  fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      coordinates: [
        [start.lng, start.lat],
        [end.lng, end.lat]
      ]
    })
  })
  .then(res => res.json())
  .then(json => {
    if (!json.features || !json.features.length) {
      alert("Failed to get route.");
      return;
    }

    let coords = json.features[0].geometry.coordinates.map(
      c => [c[1], c[0]]
    );

    routeLayer = L.polyline(coords, {
      color: "blue",
      weight: 5
    }).addTo(map);

    map.fitBounds(routeLayer.getBounds());
  })
  .catch(() => {
    alert("Error generating safe route.");
  });
}

</script>
</body>
</html>





