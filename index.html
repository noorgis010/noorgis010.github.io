<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Flood Hazard – Ramallah</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: "Segoe UI", Tahoma, sans-serif;
    }

    #map {
      position: absolute;
      top: 0; bottom: 0; left: 0; right: 0;
    }

    /* Identify popup style */
    .identify-popup h3 {
      margin: 0 0 6px 0;
      font-size: 14px;
      font-weight: bold;
    }
    .identify-popup ul {
      margin: 0;
      padding-left: 16px;
      font-size: 13px;
    }

    /* Flood report button */
    .flood-report-btn {
      background: #d32f2f;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    }
    .flood-report-btn:hover {
      background: #b71c1c;
    }

    /* Custom control container */
    .leaflet-top.leaflet-right .flood-report-control {
      margin-top: 10px;
      margin-right: 10px;
    }

    /* Modal overlay for flood report form */
    #floodModalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #floodModal {
      background: #fff;
      padding: 16px 20px;
      border-radius: 8px;
      width: 320px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.4);
    }

    #floodModal h2 {
      margin-top: 0;
      font-size: 16px;
      margin-bottom: 8px;
    }

    #floodModal label {
      font-size: 13px;
      display: block;
      margin-top: 8px;
      margin-bottom: 2px;
    }

    #floodModal input,
    #floodModal textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px;
      font-size: 13px;
      margin-bottom: 4px;
    }

    #floodModal textarea {
      resize: vertical;
      min-height: 70px;
    }

    #floodModal .modal-actions {
      text-align: right;
      margin-top: 8px;
    }

    #floodModal button {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }

    #floodModal .cancel-btn {
      background: #888;
      color: #fff;
      margin-right: 6px;
    }

    #floodModal .send-btn {
      background: #2e7d32;
      color: #fff;
    }

    /* Simple legend */
    .legend {
      background: white;
      padding: 6px 8px;
      font-size: 12px;
      line-height: 1.4;
      color: #333;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      border-radius: 4px;
    }

    .legend h4 {
      margin: 0 0 4px 0;
      font-size: 13px;
      font-weight: bold;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 2px;
    }

    .legend-color {
      width: 14px;
      height: 14px;
      margin-right: 4px;
      border: 1px solid #555;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Flood report modal -->
  <div id="floodModalOverlay">
    <div id="floodModal">
      <h2>Send Flood Report</h2>
      <p style="font-size:12px;margin:0 0 6px;">
        If you see a flood, please fill this quick report.
      </p>
      <label for="reportName">Name</label>
      <input id="reportName" type="text" placeholder="Your name">

      <label for="reportEmail">Email</label>
      <input id="reportEmail" type="email" placeholder="your@email.com">

      <label for="reportDesc">Description</label>
      <textarea id="reportDesc" placeholder="Where is the flood? how severe is it?"></textarea>

      <div class="modal-actions">
        <button class="cancel-btn" type="button" onclick="closeFloodModal()">Cancel</button>
        <button class="send-btn" type="button" onclick="submitFloodReport()">Send</button>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // =======================
    // 1. Create map
    // =======================
    const map = L.map('map').setView([32.06, 35.19], 12);

    // Basemap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // =======================
    // 2. Layer configurations
    // =======================
    const layers = {};

    // Simple color helpers
    function colorByGridcode(layerKey, value) {
      // You can customize colors per layer if you like
      const palette = {
        1: '#ffffb2',
        2: '#fecc5c',
        3: '#fd8d3c',
        4: '#f03b20',
        5: '#bd0026'
      };
      return palette[value] || '#cccccc';
    }

    // Human-readable text for each layer & gridcode
    function describeValue(layerKey, value) {
      value = Number(value);

      switch (layerKey) {
        case 'rainfall':
          return [
            '1 – Very low rainfall',
            '2 – Low rainfall',
            '3 – Moderate rainfall',
            '4 – High rainfall',
            '5 – Very high rainfall (higher flood potential)'
          ][value - 1] || 'No data';

        case 'slope':
          return [
            '1 – Very gentle / flat (water can accumulate)',
            '2 – Gentle slope',
            '3 – Moderate slope',
            '4 – Steep slope',
            '5 – Very steep slope (water runs away quickly)'
          ][value - 1] || 'No data';

        case 'dem':
          return [
            '1 – Very low elevation (near valleys, highest flood risk)',
            '2 – Low elevation',
            '3 – Medium elevation',
            '4 – High elevation',
            '5 – Very high elevation (lowest flood risk)'
          ][value - 1] || 'No data';

        case 'soil':
          // From your classification: 4 = alluvial/colluvial (highest risk)
          switch (value) {
            case 4: return '4 – Alluvial / Colluvial soils (highest flood risk: low infiltration)';
            case 3: return '3 – Terra Rossa soils (medium–high risk)';
            case 2: return '2 – Brown forest / Mediterranean brown soils (medium risk)';
            case 1: return '1 – Desert / Skeletal soils (lower flood risk here)';
            case 5: return '5 – Special / flat urban or other very sensitive soil';
            default: return 'No data';
          }

        case 'hazard':
          return [
            '1 – Very low flood hazard',
            '2 – Low flood hazard',
            '3 – Moderate flood hazard',
            '4 – High flood hazard',
            '5 – Very high flood hazard'
          ][value - 1] || 'No data';

        default:
          return 'No data';
      }
    }

    // =======================
    // 3. Load GeoJSON layers
    // =======================

    // Helper to load a GeoJSON file and add as polygon layer
    function loadPolygonLayer(url, layerKey, displayName) {
      fetch(url)
        .then(resp => resp.json())
        .then(data => {
          const layer = L.geoJSON(data, {
            style: feature => {
              const v = feature.properties.gridcode;
              return {
                color: '#555',
                weight: 1,
                fillColor: colorByGridcode(layerKey, v),
                fillOpacity: 0.45
              };
            }
          });
          layer.addTo(map);
          layers[layerKey] = { layer, name: displayName };
        })
        .catch(err => console.error('Error loading', url, err));
    }

    // Notice the %20 for spaces in file names
    loadPolygonLayer('Rainfall.json', 'rainfall', 'Rainfall');
    loadPolygonLayer('Slope%20Reclass.json', 'slope', 'Slope');
    loadPolygonLayer('DEM_Topography%20Reclass.json', 'dem', 'DEM / Topography');
    loadPolygonLayer('Soil.json', 'soil', 'Soil');
    loadPolygonLayer('Final%20Hazard%20Zones.json', 'hazard', 'Final Hazard Zones');

    // =======================
    // 4. Identify on click
    // =======================
    let identifyPopup;

    function identifyAtPoint(latlng) {
      const results = {
        rainfall: 'No feature here',
        slope: 'No feature here',
        soil: 'No feature here',
        dem: 'No feature here',
        hazard: 'No feature here'
      };

      // for each loaded layer, search features whose polygon bounds contain the point
      Object.keys(layers).forEach(key => {
        const group = layers[key].layer;
        if (!group) return;

        group.eachLayer(l => {
          if (l instanceof L.Polygon || l instanceof L.MultiPolygon) {
            if (l.getBounds().contains(latlng)) {
              const gc = l.feature && l.feature.properties
                ? l.feature.properties.gridcode
                : null;
              if (gc !== null && gc !== undefined) {
                results[key] = describeValue(key, gc);
              } else {
                results[key] = 'Feature found, but no gridcode';
              }
            }
          }
        });
      });

      const html =
        '<div class="identify-popup">' +
          '<h3>Identify Results:</h3>' +
          '<ul>' +
            '<li><strong>Rainfall:</strong> ' + results.rainfall + '</li>' +
            '<li><strong>Slope:</strong> ' + results.slope + '</li>' +
            '<li><strong>Soil:</strong> ' + results.soil + '</li>' +
            '<li><strong>Topography:</strong> ' + results.dem + '</li>' +
            '<li><strong>Hazard Zones:</strong> ' + results.hazard + '</li>' +
          '</ul>' +
        '</div>';

      if (identifyPopup) {
        identifyPopup.setLatLng(latlng).setContent(html).openOn(map);
      } else {
        identifyPopup = L.popup()
          .setLatLng(latlng)
          .setContent(html)
          .openOn(map);
      }
    }

    map.on('click', e => {
      identifyAtPoint(e.latlng);
    });

    // =======================
    // 5. Legend (for Hazard Zones)
    // =======================
    const legend = L.control({ position: 'bottomright' });

    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = '<h4>Hazard Zones (Final)</h4>';

      const grades = [1, 2, 3, 4, 5];
      const labels = [
        'Very low',
        'Low',
        'Moderate',
        'High',
        'Very high'
      ];

      grades.forEach((g, i) => {
        const color = colorByGridcode('hazard', g);
        const row = document.createElement('div');
        row.className = 'legend-item';

        const colorBox = document.createElement('span');
        colorBox.className = 'legend-color';
        colorBox.style.backgroundColor = color;

        const text = document.createElement('span');
        text.textContent = g + ' – ' + labels[i];

        row.appendChild(colorBox);
        row.appendChild(text);
        div.appendChild(row);
      });

      return div;
    };

    legend.addTo(map);

    // =======================
    // 6. Flood report control
    // =======================
    const FloodReportControl = L.Control.extend({
      onAdd: function (map) {
        const container = L.DomUtil.create('div', 'flood-report-control');
        const btn = L.DomUtil.create('button', 'flood-report-btn', container);
        btn.type = 'button';
        btn.innerText = 'Send Flood Report';

        L.DomEvent.on(btn, 'click', function (e) {
          L.DomEvent.stopPropagation(e);
          openFloodModal();
        });

        return container;
      }
    });

    map.addControl(new FloodReportControl({ position: 'topright' }));

    // =======================
    // 7. Flood report modal logic
    // =======================
    function openFloodModal() {
      document.getElementById('floodModalOverlay').style.display = 'flex';
    }

    function closeFloodModal() {
      document.getElementById('floodModalOverlay').style.display = 'none';
    }

    function submitFloodReport() {
      const name = document.getElementById('reportName').value.trim();
      const email = document.getElementById('reportEmail').value.trim();
      const desc = document.getElementById('reportDesc').value.trim();

      const bodyText =
        'Name: ' + name + '%0D%0A' +
        'Email: ' + email + '%0D%0A%0D%0A' +
        'Description:%0D%0A' + desc;

      // افتحي إيميل جاهز (غيري البريد إذا حابة)
      window.location.href = 'mailto:yourmail@example.com'
        + '?subject=Flood%20Report%20from%20Map%20User'
        + '&body=' + bodyText;

      console.log('Flood report:', { name, email, desc });
      closeFloodModal();
    }

    // خلي الدوال متاحة عالمستوى العام (لأزرار الـ HTML)
    window.openFloodModal = openFloodModal;
    window.closeFloodModal = closeFloodModal;
    window.submitFloodReport = submitFloodReport;
  </script>
</body>
</html>

