<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ù†Ø¸Ø§Ù… Ø£Ø®Ø·Ø§Ø± Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª - Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Turf.js Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙƒØ§Ù†ÙŠ -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
      background: #f5f5f5;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      left: 300px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± */
      z-index: 1;
    }

    /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
    #sidebar {
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      width: 300px;
      background: #ffffff;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      padding: 10px 12px;
      z-index: 1000;
      overflow-y: auto;
    }

    #sidebar h2 {
      margin-top: 0;
      font-size: 18px;
      text-align: center;
    }

    #sidebar h3 {
      font-size: 16px;
      margin-bottom: 6px;
      margin-top: 14px;
    }

    #risk-report, #analysis-summary {
      background: #f0f4ff;
      border-radius: 6px;
      padding: 8px;
      font-size: 13px;
      white-space: pre-line;
    }

    label, select, button {
      font-size: 13px;
    }

    #analysis-layer {
      width: 100%;
      margin: 4px 0;
      padding: 4px;
    }

    #run-analysis {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    #run-analysis:hover {
      background: #0056b3;
    }

    /* Ø²Ø± Ø§Ù„ØªØ¨Ù„ÙŠØº */
    #report-btn {
      width: 100%;
      padding: 6px;
      margin-top: 8px;
      background: #d9534f;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    #report-btn:hover {
      background: #b52b27;
    }

    /* Legend */
    .info.legend {
      background: #ffffff;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      line-height: 18px;
      font-size: 12px;
    }

    .info.legend h4 {
      margin: 0 0 4px 0;
      font-size: 13px;
      text-align: center;
    }

    .info.legend i {
      width: 14px;
      height: 14px;
      float: left;
      margin-right: 4px;
      margin-top: 2px;
      opacity: 0.8;
    }

    /* Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø´Ù…Ø§Ù„ */
    .north-arrow {
      width: 50px;
    }

    /* Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙƒÙ†ØªØ±ÙˆÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø§Ø¨ */
    .leaflet-control-container button {
      font-family: inherit;
    }
  </style>
</head>
<body>

<div id="sidebar">
  <h2>Ù†Ø¸Ø§Ù… Ø£Ø®Ø·Ø§Ø± Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª</h2>

  <h3>ØªÙ‚Ø±ÙŠØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
  <div id="risk-report">
    Ø¬Ø§Ø±Ù Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...
  </div>

  <h3>ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ¯Ø§Ø®Ù„ Ù…Ø¹ Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª</h3>
  <label for="analysis-layer">Ø§Ø®ØªØ± Ø·Ø¨Ù‚Ø© Ù„ØªØ­Ù„ÙŠÙ„ ØªØ¯Ø§Ø®Ù„Ù‡Ø§ Ù…Ø¹ Ø·Ø¨Ù‚Ø© Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª:</label>
  <select id="analysis-layer">
    <option value="">-- Ø§Ø®ØªØ± Ø·Ø¨Ù‚Ø© --</option>
  </select>
  <button id="run-analysis">ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ¯Ø§Ø®Ù„ Ù…Ø¹ Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª</button>

  <div id="analysis-summary" style="margin-top:6px;">
    Ù„Ù… ÙŠØªÙ… Ø¥Ø¬Ø±Ø§Ø¡ Ø£ÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨Ø¹Ø¯.
  </div>

  <h3>Ø§Ù„ØªØ¨Ù„ÙŠØº Ø¹Ù† Ø®Ø·Ø±</h3>
  <button id="report-btn">ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§Øº Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</button>
  <p style="font-size:11px; color:#666; margin-top:4px;">
    * Ø¹Ø¯Ù‘Ù„ÙŠ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø®ØªØµØ© (Ø¨Ù„Ø¯ÙŠØ©ØŒ Ø¯ÙØ§Ø¹ Ù…Ø¯Ù†ÙŠØŒ ÙˆØ²Ø§Ø±Ø©).
  </p>
</div>

<div id="map"></div>

<script>
  // ==============================
  // 1) Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ·Ø¨Ù‚Ø© Ø§Ù„Ø£Ø³Ø§Ø³
  // ==============================
  var map = L.map('map').setView([31.9, 35.2], 12);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  // ==========================
  // 2) Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
  // ==========================
  var currentUserLocation = null;    // LatLng Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  var floodGeoJSON = null;          // GeoJSON Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª
  var floodLayer = null;            // Leaflet layer Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª
  var intersectionLayer = null;     // Layer Ù†Ø§ØªØ¬ Ø§Ù„ØªØ¯Ø§Ø®Ù„
  var overlays = {};                // Ù„Ø£Ø¯Ø§Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø·Ø¨Ù‚Ø§Øª
  var loadedLayers = {};            // Ù„ØªØ®Ø²ÙŠÙ† geojson + leaflet layer Ù„ÙƒÙ„ Ø·Ø¨Ù‚Ø©
  var layersControl = L.control.layers(null, overlays, {collapsed: true}).addTo(map);

  var riskReportDiv = document.getElementById("risk-report");
  var analysisSelect = document.getElementById("analysis-layer");
  var analysisSummaryDiv = document.getElementById("analysis-summary");
  var reportBtn = document.getElementById("report-btn");

  // ===================================
  // 3) Ø·Ù„Ø¨ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Geolocation)
  // ===================================
  map.locate({ setView: true, maxZoom: 15 });

  map.on('locationfound', function(e) {
    currentUserLocation = e.latlng;

    L.marker(e.latlng).addTo(map)
      .bindPopup("Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ").openPopup();

    // ØªØ­Ø¯ÙŠØ« ØªÙ‚Ø±ÙŠØ± Ø£Ø®Ø·Ø§Ø± Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª Ø¹Ù†Ø¯Ù…Ø§ ØªØªÙˆÙØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª
    if (floodGeoJSON) {
      updateFloodRiskReport();
    } else {
      riskReportDiv.textContent =
        "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙƒØŒ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø·Ø¨Ù‚Ø© Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª Ù„Ø­Ø³Ø§Ø¨ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·Ø±...";
    }
  });

  map.on('locationerror', function() {
    riskReportDiv.textContent =
      "Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø¨Ø¯ÙˆÙ† ØªÙ‚Ø±ÙŠØ± Ø¢Ù„ÙŠ.";
  });

  // ===============================
  // 4) ØªØ­Ù…ÙŠÙ„ Ø·Ø¨Ù‚Ø© Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª Ø£Ø³Ø§Ø³Ù‹Ø§
  // ===============================
  function loadFloodLayer() {
    return fetch("flood.json")
      .then(res => res.json())
      .then(data => {
        floodGeoJSON = data;

        floodLayer = L.geoJSON(data, {
          style: { color: "red", weight: 2, fillOpacity: 0.35 }
        }).addTo(map);

        overlays["Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª"] = floodLayer;
        layersControl.addOverlay(floodLayer, "Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª");

        if (currentUserLocation) {
          updateFloodRiskReport();
        } else {
          riskReportDiv.textContent =
            "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø·Ø¨Ù‚Ø© Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª. Ø¬Ø§Ø±Ù Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­...";
        }
      })
      .catch(err => {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ flood.json", err);
        riskReportDiv.textContent = "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø·Ø¨Ù‚Ø© Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª.";
      });
  }

  // ===============================
  // 5) ØªØ­Ù…ÙŠÙ„ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª
  // ===============================
  var layerConfigs = [
    { key: "zones",     file: "Ramallh_zones.json", label: "Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ (Zones)",       color: "blue"   },
    { key: "elev",      file: "elev.json",          label: "Ø§Ù„Ø§Ø±ØªÙØ§Ø¹Ø§Øª (Elevation)", color: "brown"  },
    { key: "rain",      file: "rain.json",          label: "Ø§Ù„Ø£Ù…Ø·Ø§Ø± (Rainfall)",     color: "cyan"   },
    { key: "slope",     file: "slop.json",          label: "Ø§Ù„Ø§Ù†Ø­Ø¯Ø§Ø± (Slope)",       color: "orange" },
    { key: "soil",      file: "soil_new.json",      label: "Ø§Ù„ØªØ±Ø¨Ø© (Soil Type)",     color: "purple" },
    { key: "flow_acu",  file: "flow_acu.json",      label: "ØªØ±Ø§ÙƒÙ… Ø§Ù„Ø¬Ø±ÙŠØ§Ù† (Flow Acc.)", color: "green" }
    // Ø¥Ø°Ø§ Ø¨Ø¯Ùƒ ØªØ¶ÙŠÙÙŠ wasteContainer.json Ø¶ÙŠÙÙŠ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§
  ];

  function loadOtherLayers() {
    layerConfigs.forEach(function(cfg) {
      fetch(cfg.file)
        .then(res => res.json())
        .then(data => {
          var lyr = L.geoJSON(data, {
            style: { color: cfg.color, weight: 2, fillOpacity: 0.25 },
            onEachFeature: function(feature, layer) {
              // Popup Ø¨Ø³ÙŠØ· ÙŠØ¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø®ØµØ§Ø¦Øµ
              var props = feature.properties || {};
              var html = "<b>" + cfg.label + "</b><br>";
              for (var k in props) {
                html += "<b>" + k + ":</b> " + props[k] + "<br>";
              }
              layer.bindPopup(html);
            }
          });

          overlays[cfg.label] = lyr;
          layersControl.addOverlay(lyr, cfg.label);

          loadedLayers[cfg.key] = {
            label: cfg.label,
            geojson: data,
            layer: lyr,
            color: cfg.color
          };

          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø¨Ù‚Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù„Ù„ØªØ­Ù„ÙŠÙ„ (Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª Ù„Ø£Ù†Ù‡Ø§ Ø§Ù„Ø£Ø³Ø§Ø³)
          var option = document.createElement("option");
          option.value = cfg.key;
          option.textContent = cfg.label;
          analysisSelect.appendChild(option);
        })
        .catch(err => {
          console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ " + cfg.file, err);
        });
    });
  }

  // ======================================
  // 6) ØªØ­Ø¯ÙŠØ« ØªÙ‚Ø±ÙŠØ± Ø£Ø®Ø·Ø§Ø± Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª
  // ======================================
  function updateFloodRiskReport() {
    if (!currentUserLocation || !floo





