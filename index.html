<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Flood Hazard Map – Ramallah</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  body { margin:0; }
  #map { height: 100vh; }

  #reportForm {
    position:absolute; top:50px; right:20px;
    background:white; padding:15px; width:280px;
    border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.2);
    display:none; z-index:9999;
  }
  #reportBtn {
    position:absolute; top:10px; right:20px;
    z-index:9999; background:#b30000; color:#fff;
    border:none; padding:10px 15px; border-radius:5px;
    cursor:pointer; font-size:14px;
  }

</style>
</head>
<body>

<button id="reportBtn">Send Flood Report</button>

<div id="reportForm">
  <h3>Flood Report</h3>
  <label>Your Name:</label>
  <input id="name" type="text">
  <label>Description:</label>
  <textarea id="desc" rows="3"></textarea>
  <label>Coordinates:</label>
  <input id="coords" type="text" readonly>
  <button onclick="submitReport()">Submit</button>
  <button onclick="closeForm()">Close</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

var map = L.map('map').setView([31.9, 35.2], 11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

// ============ 1) Loading Layers ============

let layerData = {};   // لحفظ البيانات
let layerObjects = {}; // لحفظ طبقات Leaflet

async function loadLayer(name, url, color) {
  let r = await fetch(url);
  let json = await r.json();

  layerData[name] = json;

  let layer = L.geoJSON(json, {
    style: { color: color, weight: 1 }
  });

  layerObjects[name] = layer;
  layer.addTo(map);
}

loadLayer("Soil", "Soil.json", "#885522");
loadLayer("Rainfall", "Rainfall.json", "blue");
loadLayer("Slope", "Slope Reclass.json", "purple");
loadLayer("Topography", "DEM_Topography Reclass.json", "green");
loadLayer("Hazard Zones", "Final Hazard Zones.json", "red");


// بعد تحميل الكل — أضف Layer Control
setTimeout(() => {
  L.control.layers(null, layerObjects).addTo(map);
}, 1500);


// ============ 2) PROXIMITY IDENTIFY TOOL ============

function pointInPoly(point, polygon) {
  return leafletPip.pointInLayer(point, L.geoJSON(polygon)).length > 0;
}

// عند النقر على الخريطة:
map.on("click", function(e) {
  let lat = e.latlng.lat;
  let lng = e.latlng.lng;

  document.getElementById("coords").value = lat.toFixed(6)+","+lng.toFixed(6);

  let p = [lng, lat]; // GeoJSON order

  let result = "<b>Identify Results:</b><br><hr>";

  for (let name in layerData) {
    let features = layerData[name].features;

    let found = features.find(f => pointInside(p, f.geometry));

    if (found) {
      result += `<b>${name}:</b> ${JSON.stringify(found.properties)}<br><br>`;
    } else {
      result += `<b>${name}:</b> No feature here<br><br>`;
    }
  }

  L.popup().setLatLng(e.latlng).setContent(result).openOn(map);
});


// دالة بسيطة لفحص إذا النقطة داخل Polygon
function pointInside(point, geom) {
  try {
    let poly = L.polygon(geom.coordinates[0].map(c => [c[1], c[0]]));
    return poly.contains(L.latLng(point[1], point[0]));
  } catch {
    return false;
  }
}


// ============ 3) Flood Report Form ============

document.getElementById("reportBtn").onclick = () => {
  document.getElementById("reportForm").style.display = "block";
};

function closeForm() {
  document.getElementById("reportForm").style.display = "none";
}

function submitReport() {
  alert("Report submitted!\nWe will connect this to Google Sheet later.");
  closeForm();
}

</script>

</body>
</html>
