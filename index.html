<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Flood Hazard – Ramallah & Al-Bireh</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Turf.js -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
    }

    #sidebar {
      width: 170px;
      height: 100%;
      background: #ffffff;
      position: absolute;
      right: 0;
      top: 0;
      overflow-y: auto;
      padding: 10px;
      box-shadow: -2px 0 5px rgba(0,0,0,0.2);
      z-index: 1000;
      font-size: 12px;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 170px;
    }

    #btnHighlight, #btnReport {
      width: 100%;
      margin-top: 5px;
      padding: 5px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 11px;
    }

    #btnHighlight { background: #007bff; color: white; }
    #btnReport { background: #d9534f; color: white; }

    .legend {
      background: white;
      padding: 15px;
      font-size: 16px;
      border-radius: 10px;
      box-shadow: 0 0 12px rgba(0,0,0,0.3);
      line-height: 24px;
      width: 185px;
    }

    .legend i {
      width: 22px;
      height: 22px;
      float: left;
      margin-right: 10px;
    }

    .north-arrow {
      background: white;
      padding: 4px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.4);
    }

  </style>
</head>

<body>

<div id="sidebar">
  <h3>Flood Hazard</h3>

  <h4>Your Location</h4>
  <div id="userReport">Waiting…</div>

  <h4>Tools</h4>
  <button id="btnHighlight">Highlight Extreme Flood Risk</button>
  <button id="btnReport">Send Emergency Report</button>

  <h4>Buffer Tool</h4>
  <input id="buffDist" type="number" style="width:100%" placeholder="Distance (m)">
  <button id="btnBuffer" style="width:100%;margin-top:4px;background:#28a745;color:white;border:none;padding:5px;border-radius:6px;">
    Create Buffer
  </button>

  <div id="bufferReport" style="font-size:12px;margin-top:10px;"></div>
</div>

<div id="map"></div>

<script>

// =========================
// GLOBAL VARIABLES ⭐ UPDATE
// =========================
let userLocation = null;
let lastAnalysis = null;

let highlightActive = false;        // ⭐ UPDATE
let floodHighlightLayer = null;     // ⭐ UPDATE

let bufferLayer = null;
let bufferCircle = null;


// =========================
// Hazard Colors
// =========================
function hazardColor(level) {
  level = Number(level);
  return level === 1 ? "#00cc44" :
         level === 2 ? "#ffff33" :
         level === 3 ? "#ff9933" :
         level === 4 ? "#ff3300" :
         level === 5 ? "#990000" :
         "#555";
}


// =========================
// Map Init
// =========================
var map = L.map("map").setView([31.9, 35.2], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);


// =========================
// Detect User Location
// =========================
map.locate({setView:true,maxZoom:14});

map.on("locationfound", e=>{
  userLocation = e.latlng;
  L.marker(e.latlng).addTo(map).bindPopup("Your location");
  document.getElementById("userReport").textContent="Location detected.";
});


// =========================
// Style Functions
// =========================

// Rainfall (10 Levels)
function styleRain10(feature){
  const gc = Number(feature.properties.gridcode);
  const colors = {
    1:"#e0f2ff",2:"#cce7ff",3:"#b3daff",4:"#99ccff",5:"#80bfff",
    6:"#66b2ff",7:"#4da6ff",8:"#3399ff",9:"#1a8cff",10:"#0073e6"
  };
  return {
    color: colors[gc] || "#004c99",
    fillColor: colors[gc] || "#004c99",
    fillOpacity: .55,
    weight:1
  };
}

function styleBasic(feature){
  return {
    color: hazardColor(feature.properties.gridcode),
    weight:1,
    fillOpacity:.45
  };
}


// =========================
// Load Layers
// =========================
var layersControl = L.control.layers(null,{}, {collapsed:false}).addTo(map);

var floodLayer, zonesLayer, elevLayer, rainLayer, slopeLayer, soilLayer, flowLayer;
var floodSafePoints=null;

function loadLayer(file,style,popup,label,name){
  fetch(file).then(r=>r.json()).then(data=>{

    window[name] = L.geoJSON(data,{
      style: style,
      onEachFeature:(f,l)=>{
        let p=f.properties;
        let html="<b>Attributes:</b><br>";
        for(let k in p) html+=k+": "+p[k]+"<br>";
        l.bindPopup(html);
      }
    }).addTo(map);

    layersControl.addOverlay(window[name], label);

    if(name==="floodLayer"){
      let safe=[];
      data.features.forEach(f=>{
        if(Number(f.properties.gridcode)<=2) safe.push(turf.centroid(f));
      });
      floodSafePoints=turf.featureCollection(safe);
    }

  });
}


loadLayer("flood.json", styleBasic, null, "Flood", "floodLayer");
loadLayer("Ramallh_zones.json", styleBasic, null, "Zones","zonesLayer");
loadLayer("elev.json", styleBasic, null, "Elevation","elevLayer");
loadLayer("slop.json", styleBasic, null, "Slope","slopeLayer");
loadLayer("flow_acu.json", styleBasic, null, "Flow Accumulation","flowLayer");
loadLayer("soil_new.json", styleBasic, null, "Soil","soilLayer");

loadLayer("rain.json", styleRain10, null, "Rainfall (10 levels)","rainLayer");


// =========================
// Highlight Extreme Flood Risk ⭐ UPDATE
// =========================
document.getElementById("btnHighlight").onclick = function(){

  if(!floodLayer){ alert("Flood layer not loaded yet."); return; }

  // إطفاء الهايلايت
  if(highlightActive){
    map.removeLayer(floodHighlightLayer);
    floodHighlightLayer=null;
    highlightActive=false;
    this.style.background="#007bff";
    return;
  }

  // تشغيل الهايلايت
  highlightActive=true;
  this.style.background="orange";

  let extreme = floodLayer.toGeoJSON().features.filter(f=>{
    return Number(f.properties.gridcode) === 5;
  });

  floodHighlightLayer = L.geoJSON(extreme,{
    style:{
      color:"red",
      weight:3,
      fillColor:"red",
      fillOpacity:.35
    }
  }).addTo(map);
};


// =========================
// Buffer Tool ⭐ UPDATE
// =========================
document.getElementById("btnBuffer").onclick = function(){

  let dist = Number(document.getElementById("buffDist").value);
  if(!dist){ alert("Please enter buffer distance."); return; }

  alert("Click on map to create buffer.");

  map.once("click", function(e){

    let center = e.latlng;
    let km = dist/1000;

    let pt = turf.point([center.lng, center.lat]);
    let buff = turf.buffer(pt, km, {units:"kilometers"});

    if(bufferLayer) map.removeLayer(bufferLayer);
    if(bufferCircle) map.removeLayer(bufferCircle);

    bufferCircle=L.circle(center,{
      radius:dist,
      color:"#0066ff",
      fillOpacity:.15
    }).addTo(map);

    bufferLayer=L.geoJSON(buff,{
      style:{color:"#0066ff",weight:2,fillOpacity:0}
    }).addTo(map);

    map.fitBounds(bufferCircle.getBounds());

    analyseBuffer(buff, center, dist);
  });

};

function analyseBuffer(buff,center,dist){

  let out=`<b>Buffer Analysis</b><br>
      Center: ${center.lat.toFixed(5)}, ${center.lng.toFixed(5)}<br>
      Distance: ${dist} m<hr>`;

  function count(layer,name){
    if(!layer) return "";
    let c={};
    layer.eachLayer(l=>{
      let f=l.toGeoJSON();
      if(turf.booleanIntersects(buff,f)){
        let g=f.properties.gridcode;
        c[g]=(c[g]||0)+1;
      }
    });
    return `<b>${name}:</b> ${JSON.stringify(c)}<br>`;
  }

  out+=count(floodLayer,"Flood");
  out+=count(rainLayer,"Rainfall");
  out+=count(flowLayer,"Flow");
  out+=count(slopeLayer,"Slope");
  out+=count(elevLayer,"Elevation");
  out+=count(soilLayer,"Soil");
  out+=count(zonesLayer,"Zones");

  document.getElementById("bufferReport").innerHTML=out;
}


// =========================
// Emergency Report ⭐ UPDATE
// =========================
document.getElementById("btnReport").onclick = function(){

  if(!userLocation){
    alert("User location not detected.");
    return;
  }

  let rep = `
======= EMERGENCY FLOOD REPORT =======
Location: ${userLocation.lat}, ${userLocation.lng}
Extreme Flood Highlight: ${highlightActive ? "ON" : "OFF"}
======================================
`;

  console.log(rep);
  alert("Emergency report sent (check console).");
};


// =========================
// Legend
// =========================
var legend=L.control({position:"bottomleft"});
legend.onAdd=function(){
  var div=L.DomUtil.create("div","legend");
  div.innerHTML="<b>Flood Hazard Levels</b><br>";
  div.innerHTML+='<i style="background:#00cc44"></i> Level 1<br>';
  div.innerHTML+='<i style="background:#ffff33"></i> Level 2<br>';
  div.innerHTML+='<i style="background:#ff9933"></i> Level 3<br>';
  div.innerHTML+='<i style="background:#ff3300"></i> Level 4<br>';
  div.innerHTML+='<i style="background:#990000"></i> Level 5<br>';
  return div;
};
legend.addTo(map);


// =========================
// North Arrow
// =========================
var north=L.control({position:"topleft"});
north.onAdd=function(){
  var div=L.DomUtil.create("div","north-arrow");
  div.innerHTML=`<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Circle_arrow_north.svg/240px-Circle_arrow_north.svg.png" style="width:50px;">`;
  return div;
};
north.addTo(map);

</script>

</body>
</html>


