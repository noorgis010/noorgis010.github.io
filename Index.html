<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Flood Risk Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      direction: rtl;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    .info-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      max-width: 320px;
      font-size: 13px;
      line-height: 1.5;
    }

    .info-panel h3 {
      margin: 0 0 6px 0;
      font-size: 15px;
    }

    .info-panel p {
      margin: 3px 0;
    }

    .info-panel small {
      font-size: 10px;
      color: #777;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      color: #fff;
    }

    .badge-low {
      background-color: #27ae60;
    }

    .badge-medium {
      background-color: #f39c12;
    }

    .badge-high {
      background-color: #c0392b;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div class="info-panel" id="info-panel">
  Ø§Ù†Ù‚Ø±ÙŠ Ø¹Ù„Ù‰ Ø£ÙŠ Ù…ÙƒØ§Ù† ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø¨Ø¯Ø¡ ÙØ­Øµ Ø®Ø·ÙˆØ±Ø© Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª ğŸŒ§ï¸
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<!-- Turf.js Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø§ÙØ§Øª -->
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<script>
  // ==============================
  // 1) Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  // ==============================

  const map = L.map('map').setView([31.95, 35.23], 8); // ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ ÙˆØ³Ø· ÙÙ„Ø³Ø·ÙŠÙ† / Ø±Ø§Ù… Ø§Ù„Ù„Ù‡

  // Ø·Ø¨Ù‚Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©: OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution:
      '&copy; OpenStreetMap contributors | Rivers: Natural Earth | Elevation: Open-Elevation'
  }).addTo(map);

  const infoPanel = document.getElementById('info-panel');

  function setInfo(html) {
    infoPanel.innerHTML = html;
  }

  // ==============================
  // 2) Ø·Ø¨Ù‚Ø© Ø§Ù„Ø£Ù†Ù‡Ø§Ø± (Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª)
  // Natural Earth Rivers via geojson.xyz
  // ==============================

  let riversLayer = null;

  fetch('https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_50m_rivers_lake_centerlines.geojson')
    .then(response => response.json())
    .then(data => {
      riversLayer = L.geoJSON(data, {
        style: {
          color: '#0077be',
          weight: 1
        }
      }).addTo(map);
    })
    .catch(err => {
      console.error('Error loading rivers GeoJSON:', err);
      setInfo('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø·Ø¨Ù‚Ø© Ø§Ù„Ø£Ù†Ù‡Ø§Ø± Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§ ğŸ‘€');
    });

  // ==============================
  // 3) Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ø£Ù‚Ø±Ø¨ Ù†Ù‡Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Turf.js
  // ==============================

  function getDistanceToNearestRiver(lat, lng) {
    if (!riversLayer) return null;

    const clickPoint = turf.point([lng, lat]);
    let minDistance = Infinity;

    riversLayer.eachLayer(layer => {
      const gj = layer.toGeoJSON();
      const dist = turf.pointToLineDistance(clickPoint, gj, { units: 'meters' });
      if (dist < minDistance) {
        minDistance = dist;
      }
    });

    return isFinite(minDistance) ? minDistance : null;
  }

  // ==============================
  // 4) Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù…Ù† Open-Elevation API
  // ==============================

  async function getElevation(lat, lng) {
    try {
      const url =
        'https://api.open-elevation.com/api/v1/lookup?locations=' +
        encodeURIComponent(lat + ',' + lng);
      const res = await fetch(url);
      if (!res.ok) throw new Error('HTTP error ' + res.status);
      const json = await res.json();
      if (json && json.results && json.results.length > 0) {
        return json.results[0].elevation; // Ø¨Ø§Ù„Ø£Ù…ØªØ§Ø±
      }
    } catch (err) {
      console.error('Error getting elevation:', err);
    }
    return null; // ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ÙØ´Ù„
  }

  // ==============================
  // 5) Ù†Ù…ÙˆØ°Ø¬ Ø­Ø³Ø§Ø¨ Ø®Ø·ÙˆØ±Ø© Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª (Risk Model)
  // ==============================

  function classifyElevation(elev) {
    if (elev === null || elev === undefined) {
      return { score: 0.5, text: 'ØºÙŠØ± Ù…ØªÙˆÙØ±', detail: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù…Ù† Ø§Ù„Ø®Ø¯Ù…Ø©.' };
    }

    if (elev < 100) {
      return {
        score: 1.0,
        text: 'Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ù‹Ø§',
        detail: 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ù…Ø³ØªÙˆÙ‰ Ø³Ø·Ø­ Ø§Ù„Ø¨Ø­Ø±ØŒ Ø£ÙƒØ«Ø± Ø¹Ø±Ø¶Ø© Ù„ØªØ¬Ù…Ø¹ Ø§Ù„Ù…ÙŠØ§Ù‡.'
      };
    } else if (elev < 300) {
      return {
        score: 0.7,
        text: 'Ù…Ù†Ø®ÙØ¶',
        detail: 'Ø§Ø±ØªÙØ§Ø¹ Ù…Ù†Ø®ÙØ¶ Ù†Ø³Ø¨ÙŠÙ‹Ø§ØŒ Ø§Ø­ØªÙ…Ø§Ù„ ØªØ¬Ù…Ø¹ Ù…ÙŠØ§Ù‡ Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø±ØªÙØ¹Ø©.'
      };
    } else if (elev < 800) {
      return {
        score: 0.4,
        text: 'Ù…ØªÙˆØ³Ø·',
        detail: 'Ø§Ø±ØªÙØ§Ø¹ Ù…ØªÙˆØ³Ø·ØŒ Ø®Ø·ÙˆØ±Ø© Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª ØªØ¹ØªÙ…Ø¯ Ø£ÙƒØ«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ø§Ù„Ø£ÙˆØ¯ÙŠØ©.'
      };
    } else {
      return {
        score: 0.2,
        text: 'Ù…Ø±ØªÙØ¹ / Ø¢Ù…Ù† Ù†Ø³Ø¨ÙŠÙ‹Ø§',
        detail: 'Ø§Ø±ØªÙØ§Ø¹ Ø¹Ø§Ù„Ù ÙŠÙ‚Ù„Ù„ Ø§Ø­ØªÙ…Ø§Ù„ ØªØ±Ø§ÙƒÙ… Ù…ÙŠØ§Ù‡ Ø³Ø·Ø­ÙŠØ© ÙˆØ§Ø³Ø¹Ø©.'
      };
    }
  }

  function classifyRiverDistance(distMeters) {
    if (distMeters === null) {
      return { score: 0.5, text: 'ØºÙŠØ± Ù…ØªÙˆÙØ±', detail: 'Ù„Ù… ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ø£Ù‚Ø±Ø¨ Ù…Ø¬Ø±Ù‰ Ù…Ø§Ø¦ÙŠ.' };
    }

    if (distMeters < 200) {
      return {
        score: 1.0,
        text: 'Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ù‹Ø§ Ù…Ù† Ù…Ø¬Ø±Ù‰ Ù…Ø§Ø¦ÙŠ',
        detail: 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù„Ø§ØµÙ‚ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ Ù„ÙˆØ§Ø¯Ù Ø£Ùˆ Ù†Ù‡Ø±ØŒ Ø®Ø·ÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª Ø§Ù„Ù…ÙØ§Ø¬Ø¦Ø©.'
      };
    } else if (distMeters < 1000) {
      return {
        score: 0.6,
        text: 'Ù‚Ø±ÙŠØ¨ Ù†Ø³Ø¨ÙŠÙ‹Ø§ Ù…Ù† Ù…Ø¬Ø±Ù‰ Ù…Ø§Ø¦ÙŠ',
        detail: 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¶Ù…Ù† Ù†Ø·Ø§Ù‚ Ù‚Ø¯ ÙŠØªØ£Ø«Ø± Ø¨ÙÙŠØ¶Ø§Ù† Ø§Ù„ÙˆØ§Ø¯ÙŠ ÙÙŠ Ø­Ø§Ù„Ø© Ø£Ù…Ø·Ø§Ø± Ø´Ø¯ÙŠØ¯Ø©.'
      };
    } else {
      return {
        score: 0.2,
        text: 'Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø§Ø¦ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
        detail: 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¹ÙŠØ¯ Ø¨Ù…Ø§ ÙŠÙƒÙÙŠ Ø¹Ù† Ø§Ù„Ø£Ù†Ù‡Ø§Ø± Ø§Ù„ÙƒØ¨Ø±Ù‰ØŒ Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ£Ø«Ø± Ø¨ØªØµØ±ÙŠÙ Ù…Ø­Ù„ÙŠ.'
      };
    }
  }

  function summarizeRisk(elevScore, distScore) {
    const riskScore = Math.round((elevScore * 0.5 + distScore * 0.5) * 100);
    let level = '';
    let badgeClass = '';
    let advice = '';

    if (riskScore >= 70) {
      level = 'Ø®Ø·Ø± Ø¹Ø§Ù„Ù';
      badgeClass = 'badge-high';
      advice =
        'ØªØ¬Ù†Ù‘Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¨Ø§Ù†Ù Ø­Ø±Ø¬Ø© Ø£Ùˆ Ø±ÙƒÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ù‡Ù†Ø§ ÙÙŠ ÙØªØ±Ø§Øª Ø§Ù„Ø£Ù…Ø·Ø§Ø± Ø§Ù„ØºØ²ÙŠØ±Ø©ØŒ ÙˆØ±Ø§Ù‚Ø¨ Ù†Ø´Ø±Ø§Øª Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ù…Ø­Ù„ÙŠØ©.';
    } else if (riskScore >= 40) {
      level = 'Ø®Ø·Ø± Ù…ØªÙˆØ³Ø·';
      badgeClass = 'badge-medium';
      advice =
        'ÙŠÙØ¶Ù„ Ø§Ù„Ø­Ø°Ø± Ø®Ù„Ø§Ù„ Ø§Ù„Ø¹ÙˆØ§ØµÙ Ø§Ù„Ù…Ø·Ø±ÙŠØ©ØŒ ÙˆØªØ­Ø³ÙŠÙ† ØªØµØ±ÙŠÙ Ø§Ù„Ù…ÙŠØ§Ù‡ Ø§Ù„Ø³Ø·Ø­ÙŠØ© Ø¥Ù† Ø£Ù…ÙƒÙ† (Ù…ØµØ§Ø±ÙØŒ Ù‚Ù†ÙˆØ§Øª ØµØºÙŠØ±Ø©).';
    } else {
      level = 'Ø®Ø·Ø± Ù…Ù†Ø®ÙØ¶';
      badgeClass = 'badge-low';
      advice =
        'Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¨Ø¯Ùˆ Ø¢Ù…Ù†Ù‹Ø§ Ù†Ø³Ø¨ÙŠÙ‹Ø§ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©ØŒ Ù…Ø¹ Ø°Ù„Ùƒ ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©.';
    }

    return { riskScore, level, badgeClass, advice };
  }

  // ==============================
  // 6) Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
  // ==============================

  let currentMarker = null;

  map.on('click', async function (e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    // Ø­Ø±ÙƒÙŠ Ø§Ù„Ù…Ø§Ø±ÙƒØ± Ø¹Ù„Ù‰ Ù…ÙƒØ§Ù† Ø§Ù„Ù†Ù‚Ø±
    if (currentMarker) {
      map.removeLayer(currentMarker);
    }
    currentMarker = L.marker([lat, lng]).addTo(map);

    setInfo('Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø®Ø·ÙˆØ±Ø© Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª Ù„Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©... â³');

    // 1) Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
    const elevation = await getElevation(lat, lng);

    // 2) Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ø£Ù‚Ø±Ø¨ Ù†Ù‡Ø±
    const distToRiver = getDistanceToNearestRiver(lat, lng);

    // 3) ØªØµÙ†ÙŠÙ ÙƒÙ„ Ø¹Ø§Ù…Ù„
    const elevClass = classifyElevation(elevation);
    const distClass = classifyRiverDistance(distToRiver);

    // 4) Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    const summary = summarizeRisk(elevClass.score, distClass.score);

    // 5) Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø§Ù„Ù„ÙˆØ­Ø©
    setInfo(`
      <h3>Flood Risk Checker</h3>
      <p><strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø±:</strong><br>
         ${lat.toFixed(5)}, ${lng.toFixed(5)}</p>

      <p><strong>Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ:</strong>
         ${elevation !== null ? elevation.toFixed(0) + ' Ù…' : 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}<br>
         <em>${elevClass.text}</em><br>
         <small>${elevClass.detail}</small>
      </p>

      <p><strong>Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ø£Ù‚Ø±Ø¨ Ù†Ù‡Ø±/ÙˆØ§Ø¯ÙŠ:</strong>
         ${distToRiver !== null ? distToRiver.toFixed(0) + ' Ù…' : 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}<br>
         <em>${distClass.text}</em><br>
         <small>${distClass.detail}</small>
      </p>

      <p><strong>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø© Ø§Ù„ÙƒÙ„ÙŠØ©:</strong><br>
        <span class="badge ${summary.badgeClass}">
          ${summary.level} (${summary.riskScore}%)
        </span>
      </p>

      <p><strong>Ù†ØµÙŠØ­Ø©:</strong><br>${summary.advice}</p>

      <small>âš ï¸ Ø§Ù„Ø£Ø¯Ø§Ø© ØªÙ‚Ø¯ÙŠØ±ÙŠØ© ÙˆØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø§Ù„Ù…ÙŠØ© Ù…Ø¬Ø§Ù†ÙŠØ© (OpenStreetMap, Natural Earth, Open-Elevation) ÙˆÙ„ÙŠØ³Øª Ø¨Ø¯ÙŠÙ„Ù‹Ø§ Ø¹Ù† Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©.</small>
    `);
  });

  // Ø±Ø³Ø§Ù„Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ©
  setInfo('Ø§Ù†Ù‚Ø±ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø¹Ø±Ø¶ ØªØ­Ù„ÙŠÙ„ Ø£ÙˆÙ„ÙŠ Ù„Ø®Ø·ÙˆØ±Ø© Ø§Ù„ÙÙŠØ¶Ø§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø± ğŸŒ§ï¸');
</script>

</body>
</html>
